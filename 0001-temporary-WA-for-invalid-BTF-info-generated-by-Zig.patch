From ce85b0f77af3cbbafbfc4e56bf6364dd79675b8b Mon Sep 17 00:00:00 2001
From: Tw <tw19881113@gmail.com>
Date: Wed, 27 Dec 2023 12:02:13 +0800
Subject: [PATCH] temporary WA for invalid BTF info generated by Zig

Signed-off-by: Tw <tw19881113@gmail.com>
---
 src/libbpf.c | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/libbpf.c b/src/libbpf.c
index e067be9..e5ac47d 100644
--- a/src/libbpf.c
+++ b/src/libbpf.c
@@ -2814,6 +2814,17 @@ static int bpf_object__sanitize_btf(struct bpf_object *obj, struct btf *btf)
 				m->offset = 0;
 			}
 		}
+		// https://github.com/tw4452852/zbpf/issues/3
+		else if (btf_is_ptr(t)) {
+			t->name_off = 0;
+		} else if (btf_is_fwd(t) || btf_is_struct(t)) {
+			char *name = (char *)btf__name_by_offset(btf, t->name_off);
+			while (*name) {
+				if (!isalpha(*name))
+					*name = '_';
+				name++;
+			}
+		}
 	}

 	return 0;
@@ -3236,7 +3247,7 @@ static int bpf_object__sanitize_and_load_btf(struct bpf_object *obj)
 skip_exception_cb:

 	sanitize = btf_needs_sanitization(obj);
-	if (sanitize) {
+	if (true) {
 		const void *raw_data;
 		__u32 sz;

--
2.43.0

